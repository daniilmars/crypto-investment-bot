name: Deploy to GCE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  ZONE: us-central1-a
  INSTANCE_NAME: crypto-bot

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest tests/ -v

  deploy:
    name: Deploy to GCE VM
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Write .env file
        run: |
          cat > .env << EOF
          BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }}
          WHALE_ALERT_API_KEY=${{ secrets.WHALE_ALERT_API_KEY }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_AUTHORIZED_USER_IDS=${{ secrets.TELEGRAM_AUTHORIZED_USER_IDS }}
          NEWSAPI_ORG_KEY=${{ secrets.NEWSAPI_ORG_KEY }}
          GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          GCP_LOCATION=us-central1
          ALPHA_VANTAGE_API_KEY=${{ secrets.ALPHA_VANTAGE_API_KEY }}
          DATABASE_URL=
          DB_INSTANCE_CONNECTION_NAME=
          GCP_BILLING_ENABLED=true
          GCP_BILLING_ACCOUNT_ID=${{ secrets.GCP_BILLING_ACCOUNT_ID }}
          SERVICE_URL=${{ secrets.SERVICE_URL }}
          ENABLE_FILE_LOGGING=true
          EOF
          sed -i 's/^[[:space:]]*//' .env

      - name: Create deployment bundle
        run: |
          tar czf /tmp/deploy.tar.gz \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            -C "$GITHUB_WORKSPACE" .

      - name: Copy bundle to VM
        run: |
          gcloud compute scp /tmp/deploy.tar.gz \
            ${{ env.INSTANCE_NAME }}:/tmp/deploy.tar.gz \
            --zone=${{ env.ZONE }} --quiet

      - name: Deploy on VM
        run: |
          gcloud compute ssh ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.ZONE }} --quiet --command='
            set -e
            DEPLOY_DIR="$HOME/crypto-investment-bot"
            mkdir -p "$DEPLOY_DIR"
            tar xzf /tmp/deploy.tar.gz -C "$DEPLOY_DIR"
            rm /tmp/deploy.tar.gz
            cd "$DEPLOY_DIR"

            # Stop and remove existing container
            docker stop crypto-bot 2>/dev/null || true
            docker rm crypto-bot 2>/dev/null || true

            # Build new image
            docker build -t crypto-bot .

            # Run container
            docker run -d \
              --name crypto-bot \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file .env \
              -e GOOGLE_GENAI_USE_VERTEXAI=true \
              -v "$DEPLOY_DIR/config/settings.yaml:/app/config/settings.yaml:ro" \
              -v crypto-bot-data:/app/data \
              crypto-bot

            docker ps --filter name=crypto-bot
          '

      - name: Verify deployment
        run: |
          echo "Waiting 30s for container to start..."
          sleep 30
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "VM IP: $EXTERNAL_IP"
          curl -sf --max-time 15 "http://${EXTERNAL_IP}:8080/health" || echo "::warning::Health check failed â€” container may still be starting"
